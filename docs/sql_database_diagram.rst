.. comment:
    SPDX-FileCopyrightText: 2017-2023 Contributors to the OpenSTEF project <korte.termijn.prognoses@alliander.com>
    SPDX-License-Identifier: MPL-2.0

Огляд реляційної бази даних
===========================

OpenSTEF використовує реляційну базу даних для зберігання інформації про завдання прогнозування та вимірювання. ER-діаграма цієї бази даних показана нижче.

.. image:: _static/mysql_er_diagram.png
   :width: 6.3in
   :height: 4.24236in

Більш детально необхідні таблиці описані нижче:

клієнти
^^^^^^^
+----------------+----------+-----------------------+-----------------+
| **Ім'я**       | **Тип**  | **Коментарій**        | **Приклад**     |
+================+==========+=======================+=================+
| id             | int      | id клієнта            | 307             |
+----------------+----------+-----------------------+-----------------+
| name           | chr      | Ім'я клієнта          | Location_A      |
+----------------+----------+-----------------------+-----------------+
| vip            | bool     | дуже важливий прогноз | 1               |
|                |          |  (не підтримується)   |                 |
+----------------+----------+-----------------------+-----------------+
| active         | bool     | статус активності     | 1               |
+----------------+----------+-----------------------+-----------------+

**Customer** : Клієнт - це колекція прогнозів. Це може бути колекція прогнозів, що належить клієнту, а також колекція прогнозів, що належить певній місцевості або підстанції.

Клієнтські API Ключі
^^^^^^^^^^^^^^^^^^^^
+----------------+----------------+-------------------+-----------------+
| **Ім'я**       | **Тип**        | **Коментарій**    | **Приклад**     |
+================+================+===================+=================+
| id             | int            | id ключа API      | 94              |
+----------------+----------------+-------------------+-----------------+
| cid            | int            | id клієнта        | 307             |
+----------------+----------------+-------------------+-----------------+
| name           | chr            | Ім'я клієнта      | Location_A      |
+----------------+----------------+-------------------+-----------------+
| apiKey         | chr            | значення ключа API| uuid-Location_A |
+----------------+----------------+-------------------+-----------------+

Користувачі можуть публікувати вимірювання або отримувати прогнози, пов'язані з
конкретного клієнта (використовується всередині Alliander).

**customers_predictions**

Таблиця відповідності між ідентифікаторами клієнтів та ідентифікаторами завдань прогнозування.

+--------------------+-----------+-------------------------+-------------+
| **Ім'я**           | **Тип**   | **Коментарій**          | **Приклад** |
+====================+===========+=========================+=============+
| customer_id        | int       | id клієнта              | 307         |
+--------------------+-----------+-------------------------+-------------+
| prediction_id      | int       | id роботи передбачення  | 313         |
+--------------------+-----------+-------------------------+-------------+

загальні криві потужності
^^^^^^^^^^^^^^^^^^^^^^^^^
Містить загальні криві навантаження вітрових турбін. Ці криві мають вигляд
двопараметричні сигмоїди (центр і нахил).

+---------------+------------+----------------------------+----------------+
| **Ім'я**      | **Тип**    | **Коментарій**             | **Приклад**    |
+===============+============+============================+================+
| name          | chr        | Ім'я турбіни               | Vestas V112    |
+---------------+------------+----------------------------+----------------+
| cut_in        | float      | мінімальна швидкість вітру | 3              |
|               |            | для виробітку (м/с)        |                |
+---------------+------------+----------------------------+----------------+
| cut_off       | float      | максимальна швидкість вітру| 25             |
|               |            | для виробітку (м/с)        |                |
+---------------+------------+----------------------------+----------------+
| kind          | chr        | на берег / с берегу        | onshore        |
+---------------+------------+----------------------------+----------------+
| manufacturer  | chr        |                            | Enercon        |
+---------------+------------+----------------------------+----------------+
| peak_capacity | float      | максимальна потужність (Вт)| 3040270        |
+---------------+------------+----------------------------+----------------+
| rated_power   | float      | номінальна потужність (Вт) | 3000000        |
+---------------+------------+----------------------------+----------------+
| slope_center  | float      | швидкість вітру, яка       | 7.91           |
|               |            | відповідає 50% від         |                |
|               |            | номінальної потужності(м/с)|                |
+---------------+------------+----------------------------+----------------+
| steepness     | float      | Див. формулу               | 0.76           |
+---------------+------------+----------------------------+----------------+

В openstef/feature_engineering/weather_features.py потужність, що виробляється
вітрової турбіни обчислюється як

.. math:: P(v) = \frac{P_{rated}}{1 + e^{- k(v - c)}},

де :math:`v` швидкість вітру на висоті хаба, :math:`P_{rated}` =
rated_power, :math:`k` = steepness і :math:`c` = slope_center.

NameToLatLon
^^^^^^^^^^^^
+----------------+-----------+------------------------+----------------------+
|  **Ім'я**      | **Тип**   | **Коментарій**         | **Приклад**          |
+================+===========+========================+======================+
| regionInput    | chr       | назва регіону          | Leeuwarden           |
+----------------+-----------+------------------------+----------------------+
| lon            | decimal   | довгота                | 5.800                |
+----------------+-----------+------------------------+----------------------+
| lat            | decimal   | широта                 | 53.201               |
+----------------+-----------+------------------------+----------------------+

Ця таблиця використовується для пошуку координат певних місць, які можуть бути використані безпосередньо для отримання погодних даних.


predictions
^^^^^^^^^^^
Містить роботи передбачення.

+---------------------+-----------+------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------+
|  **Ім'я**           | **Тип**   | **Коментарій**                                                                                                                                       | **Приклад**        |
+=====================+===========+======================================================================================================================================================+====================+
| id                  | int       | ідентифікатор роботи передбачення                                                                                                                  | 313                |
+---------------------+-----------+------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------+
| name                | chr       | ім'я клієнта                                                                                                                                         | Location_A         |
+---------------------+-----------+------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------+
| forecast_type       | chr       | тип прогнозу                                                                                                                                         | demand             |
+---------------------+-----------+------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------+
| model               | chr       | тип моделі                                                                                                                                           | xgb                |
+---------------------+-----------+------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------+
| created             | datetime  |  дата створення                                                                                                                                      |  2019-05-16        |
|                     |           |  роботи передбачення                                                                                                                               |  14:53:38          |
+---------------------+-----------+------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------+
| active              | int       | 0 = off; 1 = on;                                                                                                                                     |                    |
+---------------------+-----------+------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------+
| horizon_minutes     | int       |  максимальний горизонт прогнозування                                                                                                                 |  2880              |
|                     |           |  (хвилини)                                                                                                                                           |                    |
+---------------------+-----------+------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------+
| resolution_minutes  | int       |  часова роздільність                                                                                                                                 |  15                |
|                     |           |  прогнозів (хвилини)                                                                                                                                 |                    |
+---------------------+-----------+------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------+
| train_components    | bool      | Необов’язково: виконайте розподіл енергії для цієї роботи прогнозування                                                                              |  1                 |
+---------------------+-----------+------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------+
| ean                 | chr       | EAN точки з'єднання, якщо прогноз відповідає точці з'єднання. Див. також: https://en.wikipedia.org/wiki/International_Article_Number                 | 000000000000000003 |
+---------------------+-----------+------------------------------------------------------------------------------------------------------------------------------------------------------+--------------------+

**Prediction**: Передбачення є основним поняттям в openSTEF і в основному перекладається як prediction_job в коді openSTEF. Щоб зробити прогноз, прогноз зазвичай пов'язаний з однією або декількома системами. Ці системи надають дані вимірювань, для яких робиться прогноз.

predictions_quantiles_sets
^^^^^^^^^^^^^^^^^^^^^^^^^^
Таблиця відповідності між завданнями передбачення та набором квантилів для
для прогнозування.

+-----------------+---------+--------------------------+-----------------+
| **Ім'я**        | **Тип** | **Коментарій**           | **Приклад**     |
+=================+=========+==========================+=================+
| id              | int     |                          | 22              |
+-----------------+---------+--------------------------+-----------------+
| prediction_id   | int     | id роботи передбачення   | 313             |
+-----------------+---------+--------------------------+-----------------+
| quantile_set_id | int     | id набору квантилів      | 1               |
+-----------------+---------+--------------------------+-----------------+

predictions_systems
^^^^^^^^^^^^^^^^^^^
Таблиця відповідності між роботами передбачення та системами.

+---------------+----------+--------------------------------------------------+---------------------+
|**Ім'я**       | **Тип**  | **Коментарій**                                   | **Приклад**         |
+===============+==========+==================================================+=====================+
| prediction_id | int      | id роботи передбачення                           | 317                 |
+---------------+----------+--------------------------------------------------+---------------------+
| system_id     | chr      | id системи                                       | Location_A_System_1 |
+---------------+----------+--------------------------------------------------+---------------------+
| factor        | double   | Додатковий множник для множення перед додаванням | -2.0                |
+---------------+----------+--------------------------------------------------+---------------------+

- Одна **prediction job** може відповідати декільком **systems**. 

- Одна **system** може бути пов'язана з декількома **prediction jobs**. 

- Коли кілька систем пов'язані з прогнозом, всі ці системи додаються, і прогноз робиться для суми. Якщо з якихось причин система не повинна додаватися, а відніматися, можна встановити коефіцієнт на -1. Якщо необхідно провести деяке масштабування суми, коефіцієнт може бути змінений з 1 (за замовчуванням) на бажаний коефіцієнт масштабування.

**System** : Відображає фізичну систему вимірювання. Всі метадані зберігаються в цій таблиці SQL, фактичні часові ряди можна отримати з вхідних даних за відповідним ідентифікатором системи.  

quantiles_sets
^^^^^^^^^^^^^^
Містить специфікації наборів квантилів.

+----------------+----------+---------------------+-------------------------+
| **Ім'я**       | **Тип**  | **Коментарій**      | **Приклад**             |
|                |          |                     |                         |
+================+==========+=====================+=========================+
| id             | int      | id набору квантилів |                         |
+----------------+----------+---------------------+-------------------------+
| quantiles      | json     | список              | [0.05, 0.1, 0.3, 0.5,   |
|                |          | квантилів           | 0.7, 0.9, 0.95]         |
+----------------+----------+---------------------+-------------------------+
| description    | chr      |                     | Default quantile set    |
+----------------+----------+---------------------+-------------------------+

solarspecs
^^^^^^^^^^^
Конфігурація для прогнозування PV для кожної роботи передбачення

+------------+----------+-----------------------+-------------+
| **Ім'я**   | **Тип**  | **Коментарій**        | **Приклад** |
+============+==========+=======================+=============+
| pid        | int      | id роботи передбачення| 123         |
+------------+----------+-----------------------+-------------+
| lat        | double   | широта                | 51.9850343  |
+------------+----------+-----------------------+-------------+
| lon        | double   | довгота               | 5.8956792   |
+------------+----------+-----------------------+-------------+
| radius     | int      | радіус в км           | 10          |
+------------+----------+-----------------------+-------------+
| peak_power | int      | максимальна потужність| 1000        |
+------------+----------+-----------------------+-------------+

2 випадки:

- Radius = 'None' : коли прогноз робиться для конкретної системи

- Radius > 0, коли прогноз для регіону



systems
^^^^^^^
Містить інформацію про **systems**.

+-----------------------------------+-----------+-----------------------+---------------------+
| **Ім'я**                          | **Тип**   | **Коментарій**        | **Приклад**         |
+===================================+===========+=======================+=====================+
| sid                               | chr       |  id системи           | Location_A_System_1 |
+-----------------------------------+-----------+-----------------------+---------------------+
| origin                            | chr       |  походження           |  ems (energy        |
|                                   |           |  системних даних      |  management         |
|                                   |           |                       |  system =           |
|                                   |           |                       |  SCADA)             |
+-----------------------------------+-----------+-----------------------+---------------------+
| lat                               | double    |  широта               | 5.837               |
+-----------------------------------+-----------+-----------------------+---------------------+
| lon                               | double    |  довгота              | 51.813              |
+-----------------------------------+-----------+-----------------------+---------------------+
| region                            | chr       |                       |Gelderland           |
+-----------------------------------+-----------+-----------------------+---------------------+
| timezone                          | chr       |                       |UTC                  |
+-----------------------------------+-----------+-----------------------+---------------------+
|  brand                            | chr       |  додаткова            |accurate_inc         |
|                                   |           |  інформація           |                     |
|                                   |           |  про                  |                     |
|                                   |           |  виміри               |                     |
+-----------------------------------+-----------+-----------------------+---------------------+
|  freq                             | int       |  додаткова            |5                    |
|                                   |           |  інформація           |                     |
|                                   |           |  про                  |                     |
|                                   |           |  виміри               |                     |
+-----------------------------------+-----------+-----------------------+---------------------+
|  qual                             | float     |  додаткова            |1                    |
|                                   |           |  інформація           |                     |
|                                   |           |  про                  |                     |
|                                   |           |  виміри               |                     |
+-----------------------------------+-----------+-----------------------+---------------------+
|  lag                              | float     |  додаткова            |15                   |
|                                   |           |  інформація           |                     |
|                                   |           |  про                  |                     |
|                                   |           |  виміри               |                     |
+-----------------------------------+-----------+-----------------------+---------------------+
|  created                          | datetime  |  Дата реєстрації      |2021-01-25 09:44:00  |
|                                   |           |  системи              |                     |
|                                   |           |  в openSTEF           |                     |
+-----------------------------------+-----------+-----------------------+---------------------+
|  autoupdate                       | tinyint   |  застарілий           | 1                   |
+-----------------------------------+-----------+-----------------------+---------------------+
|  polarity                         | int       |  знак                 |  -1/1               |
|                                   |           |  конвенції            |                     |
|                                   |           |  для                  |                     |
|                                   |           |  виробництва          |                     |
|                                   |           |  та навантаження      |                     |
+-----------------------------------+-----------+-----------------------+---------------------+
|  measurements_customer_api_key_id | int       |  API для публікації   |  199                |
|                                   |           |  вимірювань           |                     |
+-----------------------------------+-----------+-----------------------+---------------------+

**Polarity** коефіцієнт, який використовується для того, щоб вимірювання відповідало позитивному споживанню та негативному виробництву енергії.

systemsApiKeys
^^^^^^^^^^^^^^
Ключ API для отримання системних вимірювань.

+----------------+----------------+-------------------+-------------------+
|**Ім'я**        | **Тип**        | **Коментарій**    | **Приклад**       |
+================+================+===================+===================+
| id             | int            | id ключа API      | 199               |
+----------------+----------------+-------------------+-------------------+
| name           | chr            |                   | Measurements      |
+----------------+----------------+-------------------+-------------------+
| apiKey         | chr            | значення ключа API| uuid-Measurements |
+----------------+----------------+-------------------+-------------------+

weatherforecastlocations
^^^^^^^^^^^^^^^^^^^^^^^^
Містить розташування метеостанцій. Вони використовуються при отриманні погодних даних для передбачення.

+----------------+----------------+-----------------+-----------------+
| **Ім'я**       | **Тип**        | **Коментарій**  | **Приклад**     |
+================+================+=================+=================+
| created        | datetime       |                 | 2023-06-08      |
|                |                |                 | 18:26:44        |
+----------------+----------------+-----------------+-----------------+
| input_city     | chr            |                 | Deelen          |
+----------------+----------------+-----------------+-----------------+
| lat            | double         |                 | 52.067          |
+----------------+----------------+-----------------+-----------------+
| lon            | double         |                 | 5.8             |
+----------------+----------------+-----------------+-----------------+
| country        | chr            |                 | NL              |
+----------------+----------------+-----------------+-----------------+
| active         | int            |                 | 1               |
+----------------+----------------+-----------------+-----------------+

windspecs
^^^^^^^^^
У openstef-reference ця таблиця порожня. Містить інформацію для
прогнозу вітрової енергії, пов'язаного з роботою передбачення.

+--------------+--------------+--------------------------+-------------+
| **Ім'я**     | **Тип**      | **Коментарій**           | **Приклад** |
+==============+==============+==========================+=============+
| pid          | int          | id роботи передбачення   |             |
+--------------+--------------+--------------------------+-------------+
| lat          | double       |                          |             |
+--------------+--------------+--------------------------+-------------+
| lon          | double       |                          |             |
+--------------+--------------+--------------------------+-------------+
| turbine_type | chr          | відповідає полю          |             |
|              |              | «ім’я» у загальних       |             |
|              |              | кривих потужності        |             |
+--------------+--------------+--------------------------+-------------+
| n_turbines   | int          | кількість вітрових турбін|             |
+--------------+--------------+--------------------------+-------------+
| hub_height   | int          | висота турбіни           |             |
|              |              | (м)                      |             |
+--------------+--------------+--------------------------+-------------+

Висота хаба використовується для екстраполяції прогнозу швидкості вітру на
правильній висоті.
